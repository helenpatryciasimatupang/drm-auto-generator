<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>RFP Auto Generator ‚Äî Final</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; background: #f5f6f7; padding: 20px; }
    h2 { margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #eee; }
    button { padding: 8px 14px; margin-top: 10px; cursor: pointer; }
    input { width: 100%; padding: 5px; }
    .ok { color: green; font-weight: bold; }
  </style>
</head>
<body>

<h1>RFP AUTO GENERATOR ‚Äî FINAL</h1>

<h2>1Ô∏è‚É£ Upload Monitoring Daily (CSV)</h2>
<input type="file" id="monitoringFile" accept=".csv">

<h2>2Ô∏è‚É£ Upload Master Pop Up (Excel)</h2>
<input type="file" id="masterFile" accept=".xlsx,.xls">

<h2>3Ô∏è‚É£ Input Area</h2>
<table id="areaTable">
  <thead>
    <tr>
      <th>FDTID HOTLIST</th>
      <th>Drawing No (5 digit)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input class="fdtid"></td>
      <td><input class="drawingNo"></td>
    </tr>
  </tbody>
</table>

<button onclick="addArea()">‚ûï Tambah Area</button>
<br><br>
<button onclick="generateRFP()">üì• Generate RFP</button>

<p id="status"></p>

<script>
let monitoringData = [];
let masterData = [];

// ================= UPLOAD FILE =================
document.getElementById("monitoringFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const lines = evt.target.result.split("\n");
    const headers = lines[0].split(",").map(h => h.trim());
    monitoringData = lines.slice(1).map(line => {
      const obj = {};
      line.split(",").forEach((v, i) => obj[headers[i]] = v.trim());
      return obj;
    });
    document.getElementById("status").innerHTML =
      `<span class="ok">Monitoring loaded (${monitoringData.length} data)</span>`;
  };
  reader.readAsText(e.target.files[0]);
});

document.getElementById("masterFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, { type: "binary" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    masterData = XLSX.utils.sheet_to_json(sheet);
    document.getElementById("status").innerHTML +=
      ` | <span class="ok">Master Pop Up loaded (${masterData.length} row)</span>`;
  };
  reader.readAsBinaryString(e.target.files[0]);
});

// ================= AREA =================
function addArea() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input class="fdtid"></td>
    <td><input class="drawingNo"></td>
  `;
  document.querySelector("#areaTable tbody").appendChild(row);
}

// ================= GENERATE =================
function generateRFP() {
  if (!monitoringData.length || !masterData.length) {
    alert("File belum lengkap");
    return;
  }

  let result = [];
  const rows = document.querySelectorAll("#areaTable tbody tr");

  rows.forEach(row => {
    const fdtid = row.querySelector(".fdtid").value.trim();
    const drawing = row.querySelector(".drawingNo").value.trim();
    if (!fdtid || !drawing) return;

    // üî• AUTO FDT CODING
    const fdtCoding = fdtid + "EXT";

    const masterFDT = masterData.filter(m =>
      String(m["FDT_CODE"]).trim() === fdtCoding
    );

    let lat = "", lon = "";
    let hpDesign = masterFDT.length;
    let hpRes = 0;
    let biz = 0;

    if (masterFDT.length) {
      lat = masterFDT[0]["BUILDING_LATITUDE"] || "";
      lon = masterFDT[0]["BUILDING_LONGITUDE"] || "";

      hpRes = masterFDT.filter(m => m["HOME/HOME-BIZ"] === "HOME").length;
      biz = masterFDT.filter(m => m["HOME/HOME-BIZ"] === "HOME-BIZ").length;
    }

    result.push({
      "FDTID HOTLIST": fdtid,
      "FDT Coding": fdtCoding,
      "Drawing No": drawing,
      "Latitude": lat,
      "Longitude": lon,
      "HP Design": hpDesign,
      "HP Residential": hpRes,
      "Bizz Pass": biz
    });
  });

  exportExcel(result);
}

// ================= EXPORT =================
function exportExcel(data) {
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "RFP");
  XLSX.writeFile(wb, "RFP_Auto_Generator.xlsx");
}
</script>

</body>
</html>
